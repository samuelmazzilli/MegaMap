<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapChart Pro - Premium UI Edition</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            /* Palette Colori Premium */
            --bg-ocean: #1e293b; /* Oceano scuro */
            --panel-bg: rgba(15, 23, 42, 0.95); /* Slate 900 semi-trasparente */
            --card-bg: rgba(255, 255, 255, 0.03);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #3b82f6; /* Blue 500 */
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --border-light: rgba(255, 255, 255, 0.08);
        }
        
        body {
            margin: 0; overflow: hidden; background-color: var(--bg-ocean);
            font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
            color: var(--text-main); user-select: none; transition: background 0.5s;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        
        /* --- MAIN MENU STYLES --- */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at top right, #1e293b 0%, #020617 100%);
            z-index: 50;
        }
        .menu-title { font-size: 4rem; margin: 0 0 10px 0; font-weight: 800; background: linear-gradient(to right, #60a5fa, #c084fc); -background-clip: text; -webkit-text-fill-color: transparent; }
        .menu-subtitle { font-size: 1.2rem; color: var(--text-muted); margin-bottom: 50px; font-weight: 300; }
        
        .menu-grid { display: flex; gap: 25px; max-width: 1050px; width: 90%; }
        .menu-card {
            background: var(--card-bg); border: 1px solid var(--border-light);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 35px; border-radius: 20px; flex: 1;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .menu-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); }
        .menu-card h2 { margin: 0 0 15px 0; font-size: 1.5rem; color: #fff; display: flex; align-items: center; gap: 10px; }
        
        /* --- INPUT & BUTTONS --- */
        select, .search-input, .code-input, .legend-input {
            width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border-light);
            font-size: 0.95rem; outline: none; background: rgba(0, 0, 0, 0.2); color: var(--text-main);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; font-family: inherit;
            transition: border-color 0.2s, background 0.2s;
        }
        select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 16px; padding-right: 40px; }
        select:focus, .search-input:focus, .code-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.4); }
        .code-input { font-family: 'Fira Code', monospace; font-size: 0.85rem; height: 80px; resize: none; color: #a78bfa; }

        .btn {
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-light); padding: 12px 16px;
            border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;
            color: var(--text-main); text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        
        .btn-primary { background: linear-gradient(135deg, var(--accent), #4f46e5); color: white; border: none; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, var(--accent-hover), #4338ca); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; border: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .btn-success:hover { background: linear-gradient(135deg, #059669, #047857); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

        /* --- EDITOR STYLES --- */
        #editor-ui { display: none; width: 100vw; height: 100vh; }
        
        #sidebar {
            position: absolute; top: 0; left: 0; width: 380px; height: 100vh;
            background: var(--panel-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-light); box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            z-index: 10; display: flex; flex-direction: column;
        }
        
        .header { padding: 25px 20px; background: rgba(0,0,0,0.2); text-align: center; border-bottom: 1px solid var(--border-light); }
        .header h1 { margin: 0; font-size: 1.6rem; letter-spacing: 0.5px; font-weight: 800; color: #fff; }
        .header p { margin: 5px 0 0 0; font-size: 0.85rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        .tools { padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        .control-group { background: var(--card-bg); border: 1px solid var(--border-light); border-radius: 16px; padding: 20px; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 12px; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;}
        
        .toolbar-flex { display: flex; gap: 10px; align-items: center; }
        
        /* Color Picker Custom */
        .color-picker-wrapper { display: flex; align-items: center; background: rgba(0,0,0,0.2); border: 1px solid var(--border-light); border-radius: 10px; padding: 5px 15px 5px 5px; gap: 12px; flex-grow: 1;}
        input[type="color"] { appearance: none; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; padding: 0; background: transparent; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid rgba(255,255,255,0.2); border-radius: 6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
        #colorHex { font-family: 'Fira Code', monospace; font-size: 0.95rem; font-weight: 600; color: #fff; text-transform: uppercase;}
        
        /* Search */
        #searchResults { position: absolute; width: calc(100% - 40px); max-height: 250px; overflow-y: auto; background: #1e293b; border: 1px solid var(--border-light); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 20; display: none; margin-top: 5px;}
        .search-category { background: rgba(0,0,0,0.3); font-size: 0.75rem; font-weight: 700; color: var(--accent); padding: 8px 15px; text-transform: uppercase; }
        .search-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .search-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .search-item span { font-size: 0.8rem; color: var(--text-muted); }

        /* Legenda */
        .legend-title { font-size: 1rem; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #fff;}
        .legend-count { background: rgba(59, 130, 246, 0.2); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; border: 1px solid rgba(59, 130, 246, 0.3);}
        #legend-list { display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid var(--border-light); transition: border-color 0.2s; }
        .legend-item:hover { border-color: rgba(255,255,255,0.2); }
        .color-box { width: 24px; height: 24px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        .legend-input { padding: 4px 8px; font-size: 0.9rem; background: transparent; border: 1px solid transparent; }
        .legend-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.3); }

        /* Area Mappa */
        #map-container { position: absolute; top: 0; left: 380px; width: calc(100vw - 380px); height: 100vh; cursor: grab; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
        #map-container:active { cursor: grabbing; }
        svg { width: 100%; height: 100%; }
        
        .area { stroke: rgba(255,255,255,0.15); stroke-width: 0.5px; vector-effect: non-scaling-stroke; transition: fill 0.15s ease, stroke 0.2s; cursor: pointer; }
        .area:hover { stroke: #fff; stroke-width: 1.5px; }
        
        #tooltip { position: absolute; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); color: white; padding: 12px 18px; border-radius: 12px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 20; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        
        #loading { position: absolute; top: 50%; left: calc(50% + 190px); transform: translate(-50%, -50%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); color: white; padding: 40px 60px; border-radius: 20px; font-size: 1.4rem; font-weight: bold; display: none; pointer-events: none; z-index: 100; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 1px solid rgba(59, 130, 246, 0.3); }
        .spinner { margin-top: 15px; font-size: 0.9rem; color: var(--text-muted); font-weight: normal; }

        #toast { position: absolute; bottom: 30px; left: calc(50% + 190px); transform: translateX(-50%); background: var(--success); color: white; padding: 14px 28px; border-radius: 30px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; z-index: 200; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <div id="main-menu">
        <h1 class="menu-title">Map Editor Pro</h1>
        <p class="menu-subtitle">La piattaforma definitiva per la creazione geopolitica</p>
        
        <div class="menu-grid">
            <div class="menu-card">
                <h2>‚ú® Nuovo Progetto</h2>
                <label style="color: var(--text-muted); margin-bottom: 8px; display: block; font-size: 0.9rem;">Seleziona la mappa base:</label>
                <select id="startMapSelector" style="margin-bottom: 20px;">
                    <option value="world_countries">üåç Mondo (Solo Nazioni - Veloce)</option>
                    <option value="world_regions">üó∫Ô∏è Mondo (TUTTE le Regioni - 40MB)</option>
                    <option value="italy">üáÆüáπ Italia (Regioni)</option>
                    <option value="usa">üá∫üá∏ Stati Uniti (Stati)</option>
                </select>
                <button class="btn btn-primary" id="btnStartNew" style="margin-top: auto; padding: 15px; font-size: 1.1rem;">Avvia Workspace</button>
            </div>

            <div class="menu-card">
                <h2>üíæ Memoria Locale</h2>
                <label style="color: var(--text-muted); margin-bottom: 8px; display: block; font-size: 0.9rem;">Seleziona uno slot:</label>
                <select id="menuSaveSlot" style="margin-bottom: 20px;">
                    <option value="slot_1">Slot 1: Vuoto</option>
                    <option value="slot_2">Slot 2: Vuoto</option>
                    <option value="slot_3">Slot 3: Vuoto</option>
                    <option value="slot_4">Slot 4: Vuoto</option>
                    <option value="slot_5">Slot 5: Vuoto</option>
                </select>
                <button class="btn btn-success" id="btnLoadLocal" style="margin-top: auto; padding: 15px; font-size: 1.1rem;">Carica ed Entra</button>
            </div>

            <div class="menu-card">
                <h2>üì• Importa Codice</h2>
                <label style="color: var(--text-muted); margin-bottom: 8px; display: block; font-size: 0.9rem;">Incolla il codice Base64:</label>
                <textarea id="menuImportCode" class="code-input" placeholder="eyJtYXBUeXBlIjoid29ybGRfY291bnRyaWVz..."></textarea>
                <button class="btn" id="btnImportCode" style="margin-top: auto; padding: 15px; font-size: 1.1rem; background: rgba(167, 139, 250, 0.1); color: #a78bfa; border-color: rgba(167, 139, 250, 0.3);">‚¨áÔ∏è Importa Dati</button>
            </div>
        </div>
    </div>

    <div id="editor-ui">
        <div id="sidebar">
            <div class="header">
                <h1>Workspace</h1>
                <p id="currentMapDisplay">Mappa Attiva</p>
            </div>
            <div class="tools">
                
                <div class="control-group">
                    <label>üñåÔ∏è Strumenti Pittura</label>
                    <div class="toolbar-flex" style="margin-bottom: 12px;">
                        <div class="color-picker-wrapper">
                            <input type="color" id="colorPicker" value="#e11d48">
                            <span id="colorHex">#E11D48</span>
                        </div>
                        <button class="btn" id="eraserBtn" title="Gomma" style="padding: 10px 15px;">üßπ</button>
                    </div>
                    
                    <div style="position: relative;">
                        <input type="text" id="searchInput" class="search-input" placeholder="üîç Cerca Nazione o Regione...">
                        <div id="searchResults"></div>
                    </div>
                    
                    <button class="btn btn-danger" id="clearBtn" style="margin-top: 12px; width: 100%;">üóëÔ∏è Resetta Mappa</button>
                </div>

                <div id="legend-container" class="control-group">
                    <div class="legend-title">
                        üìö Legenda Fazioni 
                        <span class="legend-count" id="legend-count">0</span>
                    </div>
                    <div id="legend-list">
                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic; text-align: center; padding: 10px 0;">Colora la mappa per iniziare.</div>
                    </div>
                </div>

                <div class="control-group">
                    <label>‚öôÔ∏è Gestione Sistema</label>
                    <select id="editorSaveSlot" style="margin-bottom: 12px;">
                        <option value="slot_1">Sovrascrivi Slot 1</option>
                        <option value="slot_2">Sovrascrivi Slot 2</option>
                        <option value="slot_3">Sovrascrivi Slot 3</option>
                        <option value="slot_4">Sovrascrivi Slot 4</option>
                        <option value="slot_5">Sovrascrivi Slot 5</option>
                    </select>
                    <div class="toolbar-flex">
                        <button class="btn btn-success" id="btnSaveExit" style="flex: 2;">üíæ Salva & Menu</button>
                        <button class="btn" id="btnCopyExport" style="flex: 1;" title="Copia codice export">üìã Export</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="map-container">
            <svg id="world-map"></svg>
        </div>
        
        <div id="tooltip"></div>
        <div id="loading">
            <div style="color: var(--accent); margin-bottom: 10px;">‚ö°</div>
            Elaborazione Geografica in corso...
            <div class="spinner">L'algoritmo sta calcolando i vettori. Attendere.</div>
        </div>
    </div>

    <div id="toast">Operazione completata!</div>

    <script>
        // Manteniamo esattamente la logica JavaScript perfetta del passaggio precedente,
        // aggiornando solo il colore di base per abbinarlo alla nuova UI scura.
        const defaultLandHex = "#334155"; // Slate 700 per i territori vuoti
        
        const AppManager = {
            mapSources: {
                world_countries: { url: "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", name: "Mondo (Nazioni)" },
                world_regions: { url: "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson", name: "Mondo (Regioni)" },
                italy: { url: "https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_regions.geojson", name: "Italia (Regioni)" },
                usa: { url: "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json", name: "USA (Stati)" }
            },
            
            showToast: function(message, isError = false) {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.style.background = isError ? "var(--danger)" : "var(--success)";
                toast.style.opacity = 1;
                toast.style.transform = "translateX(-50%) translateY(-10px)";
                setTimeout(() => {
                    toast.style.opacity = 0;
                    toast.style.transform = "translateX(-50%) translateY(0)";
                }, 3000);
            },

            refreshSlots: function() {
                const menuSelect = document.getElementById('menuSaveSlot');
                const editorSelect = document.getElementById('editorSaveSlot');
                
                for (let i = 1; i <= 5; i++) {
                    const slotId = `slot_${i}`;
                    const savedData = localStorage.getItem(`mapchart_save_${slotId}`);
                    let textMenu = `Slot ${i}: Vuoto`;
                    let textEditor = `Salva su Slot ${i} (Vuoto)`;
                    
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            const mapName = this.mapSources[parsed.mapType].name;
                            textMenu = `Slot ${i}: ${mapName} (${parsed.timestamp})`;
                            textEditor = `Sovrascrivi Slot ${i} (${mapName})`;
                        } catch (e) {
                            textMenu = `Slot ${i}: Dati Corrotti`;
                        }
                    }
                    menuSelect.options[i-1].text = textMenu;
                    editorSelect.options[i-1].text = textEditor;
                }
            },

            goToEditor: async function(mapType, stateData = null) {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';
                document.getElementById('currentMapDisplay').innerText = this.mapSources[mapType].name;
                
                editor.resize(); 
                
                await editor.loadMap(mapType, this.mapSources[mapType].url);
                if (stateData) {
                    editor.applyState(stateData);
                }
            },

            goToMenu: function() {
                document.getElementById('editor-ui').style.display = 'none';
                document.getElementById('main-menu').style.display = 'flex';
                this.refreshSlots();
            }
        };

        class UltimateMapEditor {
            constructor() {
                this.container = d3.select("#map-container");
                this.svg = d3.select("#world-map");
                this.tooltip = d3.select("#tooltip");
                this.loading = document.getElementById("loading");
                
                this.currentColor = "#e11d48";
                this.defaultLandColor = defaultLandHex;
                this.legendLabels = {};
                this.currentMapType = null;
                
                this.g = this.svg.append("g");
                this.currentFeatures = [];
                this.currentPathGenerator = null;

                this.initUI();
                this.initZoom();
                window.addEventListener('resize', () => this.resize());
            }

            initUI() {
                const colorInput = document.getElementById('colorPicker');
                const colorHex = document.getElementById('colorHex');
                
                colorInput.addEventListener('input', (e) => { this.currentColor = e.target.value; colorHex.textContent = this.currentColor.toUpperCase(); });
                document.getElementById('eraserBtn').addEventListener('click', () => { this.currentColor = this.defaultLandColor; colorHex.textContent = "GOMMA"; });
                document.getElementById('clearBtn').addEventListener('click', () => { this.g.selectAll(".area").attr("fill", this.defaultLandColor); this.updateLegend(); });
                
                document.getElementById('btnSaveExit').addEventListener('click', () => {
                    const slot = document.getElementById('editorSaveSlot').value;
                    const state = this.generateState();
                    localStorage.setItem(`mapchart_save_${slot}`, JSON.stringify(state));
                    AppManager.showToast("Progetto Salvato!");
                    AppManager.goToMenu();
                });

                document.getElementById('btnCopyExport').addEventListener('click', () => {
                    const state = this.generateState();
                    const code = btoa(encodeURIComponent(JSON.stringify(state)));
                    navigator.clipboard.writeText(code).then(() => {
                        AppManager.showToast("Codice copiato negli appunti!");
                    }).catch(() => {
                        AppManager.showToast("Errore nella copia!", true);
                    });
                });

                this.initSearch();
            }

            generateState() {
                const coloredAreas = {};
                this.g.selectAll(".area").each(function() {
                    const fill = d3.select(this).attr("fill");
                    const id = d3.select(this).attr("id");
                    if (fill !== defaultLandHex && fill !== "rgb(51, 65, 85)") {
                        coloredAreas[id] = fill;
                    }
                });
                return { mapType: this.currentMapType, colors: coloredAreas, legend: this.legendLabels, timestamp: new Date().toLocaleString() };
            }

            applyState(stateData) {
                this.g.selectAll(".area").attr("fill", this.defaultLandColor);
                if (stateData.colors) {
                    for (const [id, color] of Object.entries(stateData.colors)) {
                        d3.select("#" + id).attr("fill", color);
                    }
                }
                this.legendLabels = stateData.legend || {};
                this.updateLegend();
            }

            initSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchResults = document.getElementById('searchResults');

                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase().trim();
                    searchResults.innerHTML = '';
                    if (val.length < 2) { searchResults.style.display = 'none'; return; }

                    const matchedNations = new Set();
                    const matchedRegions = [];

                    this.currentFeatures.forEach(d => {
                        const name = (d.properties.name || d.properties.reg_name || d.properties.NAME || "").toLowerCase();
                        const admin = (d.properties.admin || d.properties.admin0 || "").toLowerCase();
                        if (admin.includes(val) && admin !== "") matchedNations.add(d.properties.admin || d.properties.admin0);
                        if (name.includes(val)) matchedRegions.push(d);
                    });

                    let hasResults = false;

                    if (matchedNations.size > 0) {
                        hasResults = true;
                        const catTitle = document.createElement('div'); catTitle.className = 'search-category'; catTitle.textContent = 'Nazioni'; searchResults.appendChild(catTitle);
                        Array.from(matchedNations).slice(0, 5).forEach(nation => {
                            const div = document.createElement('div'); div.className = 'search-item'; div.innerHTML = `<b>${nation}</b> <span>(Colora tutto)</span>`;
                            div.addEventListener('click', () => { this.colorAndZoomNation(nation); searchInput.value = ''; searchResults.style.display = 'none'; });
                            searchResults.appendChild(div);
                        });
                    }

                    if (matchedRegions.length > 0) {
                        hasResults = true;
                        const catTitle = document.createElement('div'); catTitle.className = 'search-category'; catTitle.textContent = 'Regioni'; searchResults.appendChild(catTitle);
                        matchedRegions.slice(0, 10).forEach(d => {
                            const name = d.properties.name || d.properties.reg_name || d.properties.NAME;
                            const admin = d.properties.admin || d.properties.admin0 || "";
                            const div = document.createElement('div'); div.className = 'search-item'; div.innerHTML = `${name} <span>${admin}</span>`;
                            div.addEventListener('click', () => {
                                const pathId = "#path-" + this.currentFeatures.indexOf(d); d3.select(pathId).attr("fill", this.currentColor);
                                this.updateLegend(); this.zoomToFeature(d); searchInput.value = ''; searchResults.style.display = 'none';
                            });
                            searchResults.appendChild(div);
                        });
                    }
                    searchResults.style.display = hasResults ? 'block' : 'none';
                });
                document.addEventListener('click', (e) => { if (e.target.id !== 'searchInput') searchResults.style.display = 'none'; });
            }

            colorAndZoomNation(nationName) {
                this.g.selectAll(".area").filter(d => (d.properties.admin === nationName || d.properties.admin0 === nationName)).attr("fill", this.currentColor);
                this.updateLegend();
                const matchingFeatures = this.currentFeatures.filter(d => (d.properties.admin === nationName || d.properties.admin0 === nationName));
                if (matchingFeatures.length === 0 || !this.currentPathGenerator) return;

                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                matchingFeatures.forEach(d => {
                    const bounds = this.currentPathGenerator.bounds(d);
                    if (bounds[0][0] < minX) minX = bounds[0][0]; if (bounds[0][1] < minY) minY = bounds[0][1];
                    if (bounds[1][0] > maxX) maxX = bounds[1][0]; if (bounds[1][1] > maxY) maxY = bounds[1][1];
                });
                const dx = maxX - minX, dy = maxY - minY, x = (minX + maxX) / 2, y = (minY + maxY) / 2;
                const scale = Math.max(1, Math.min(40, 0.8 / Math.max(dx / this.width, dy / this.height)));
                const translate = [this.width / 2 - scale * x, this.height / 2 - scale * y];
                this.svg.transition().duration(1200).call(this.zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
            }

            zoomToFeature(d) {
                if (!this.currentPathGenerator) return;
                const bounds = this.currentPathGenerator.bounds(d);
                const dx = bounds[1][0] - bounds[0][0], dy = bounds[1][1] - bounds[0][1], x = (bounds[0][0] + bounds[1][0]) / 2, y = (bounds[0][1] + bounds[1][1]) / 2;
                const scale = Math.max(1, Math.min(80, 0.6 / Math.max(dx / this.width, dy / this.height)));
                const translate = [this.width / 2 - scale * x, this.height / 2 - scale * y];
                this.svg.transition().duration(1000).call(this.zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
            }

            updateLegend() {
                const usedColors = new Set();
                this.g.selectAll(".area").each(function() { usedColors.add(d3.select(this).attr("fill")); });
                usedColors.delete(this.defaultLandColor); usedColors.delete("rgb(51, 65, 85)");

                const legendList = document.getElementById('legend-list');
                document.getElementById('legend-count').innerText = usedColors.size;
                legendList.innerHTML = '';

                if (usedColors.size === 0) { legendList.innerHTML = '<div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic; text-align: center; padding: 10px 0;">Colora la mappa per iniziare.</div>'; return; }

                usedColors.forEach(color => {
                    if (!this.legendLabels[color]) this.legendLabels[color] = `Fazione ${color.toUpperCase().substring(1,4)}`;
                    const itemDiv = document.createElement('div'); itemDiv.className = 'legend-item';
                    const colorBox = document.createElement('div'); colorBox.className = 'color-box'; colorBox.style.background = color;
                    colorBox.addEventListener('click', () => { document.getElementById('colorPicker').value = color; document.getElementById('colorHex').textContent = color.toUpperCase(); this.currentColor = color; });
                    const inputField = document.createElement('input'); inputField.type = 'text'; inputField.className = 'legend-input'; inputField.value = this.legendLabels[color];
                    inputField.addEventListener('input', (e) => { this.legendLabels[color] = e.target.value; });
                    itemDiv.appendChild(colorBox); itemDiv.appendChild(inputField); legendList.appendChild(itemDiv);
                });
            }

            initZoom() {
                this.zoom = d3.zoom().scaleExtent([0.5, 150]).on("zoom", (event) => { this.g.attr("transform", event.transform); });
                this.svg.call(this.zoom);
            }

            resize() {
                if(document.getElementById('editor-ui').style.display === 'none') return;
                this.width = this.container.node().getBoundingClientRect().width;
                this.height = this.container.node().getBoundingClientRect().height;
            }

            async loadMap(mapType, url) {
                this.currentMapType = mapType;
                this.g.selectAll("*").remove(); 
                this.svg.transition().duration(0).call(this.zoom.transform, d3.zoomIdentity); 
                this.loading.style.display = "block";
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Network error");
                    const geoData = await response.json();
                    
                    this.loading.style.display = "none";
                    this.currentFeatures = geoData.features; 
                    this.drawMap(geoData);
                } catch (err) {
                    this.loading.style.display = "none";
                    AppManager.showToast("Errore di rete. Impossibile scaricare la mappa.", true);
                    AppManager.goToMenu();
                }
            }

            drawMap(geoData) {
                const projection = d3.geoMercator().fitSize([this.width - 20, this.height - 20], geoData);
                this.currentPathGenerator = d3.geoPath().projection(projection);

                this.g.selectAll("path")
                    .data(geoData.features)
                    .enter().append("path").attr("class", "area").attr("id", (d, i) => "path-" + i) 
                    .attr("d", this.currentPathGenerator).attr("fill", this.defaultLandColor)
                    .on("mouseover", (event, d) => {
                        const name = d.properties.name || d.properties.reg_name || d.properties.NAME || "Area";
                        const admin = d.properties.admin || d.properties.admin0 || ""; 
                        let tooltipText = `<b style="font-size:16px;">${name}</b>`;
                        if (admin && admin !== name) tooltipText += `<br><span style="color:var(--text-muted);">${admin}</span>`;
                        const currentFill = d3.select(event.currentTarget).attr("fill");
                        if (currentFill !== this.defaultLandColor && currentFill !== "rgb(51, 65, 85)" && this.legendLabels[currentFill]) {
                            tooltipText += `<hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:8px 0;"><span style="color:${currentFill}; font-size:18px;">‚ñ†</span> <b style="color:white;">${this.legendLabels[currentFill]}</b>`;
                        }
                        this.tooltip.style("opacity", 1).html(tooltipText);
                    })
                    .on("mousemove", (event) => { this.tooltip.style("left", (event.pageX + 20) + "px").style("top", (event.pageY - 20) + "px"); })
                    .on("mouseout", () => { this.tooltip.style("opacity", 0); })
                    .on("click", (event, d) => { d3.select(event.currentTarget).attr("fill", this.currentColor); this.updateLegend(); });
                
                this.updateLegend();
            }
        }

        const editor = new UltimateMapEditor();
        AppManager.refreshSlots();

        document.getElementById('btnStartNew').addEventListener('click', () => {
            const mapType = document.getElementById('startMapSelector').value;
            AppManager.goToEditor(mapType);
        });

        document.getElementById('btnLoadLocal').addEventListener('click', () => {
            const slot = document.getElementById('menuSaveSlot').value;
            const savedData = localStorage.getItem(`mapchart_save_${slot}`);
            if (savedData) {
                const state = JSON.parse(savedData);
                AppManager.goToEditor(state.mapType, state);
            } else {
                AppManager.showToast("Lo slot selezionato √® vuoto!", true);
            }
        });

        document.getElementById('btnImportCode').addEventListener('click', () => {
            const code = document.getElementById('menuImportCode').value.trim();
            if (!code) { AppManager.showToast("Inserisci un codice!", true); return; }
            try {
                const jsonString = decodeURIComponent(atob(code));
                const state = JSON.parse(jsonString);
                if (!state.mapType || !state.colors) throw new Error("Invalid");
                AppManager.goToEditor(state.mapType, state);
            } catch (e) {
                AppManager.showToast("Codice corrotto o invalido!", true);
            }
        });
    </script>
</body>
</html>